name: Deploy Backend to AWS Lightsail Instance

on:
  push:
    branches:
      - main
    paths:
      - 'watermark_backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Lightsail Instance
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          envs: DATABASE_URL,FRONTEND_URL,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_S3_BUCKET,AWS_REGION
          script: |
            # Create app directory
            mkdir -p ~/watermark-backend
            cd ~/watermark-backend

            # Clone or pull latest code
            if [ -d ".git" ]; then
              git pull origin main
            else
              git clone https://github.com/DrOksusu/watermark.git .
            fi

            # Navigate to backend folder
            cd watermark_backend

            # Create .env file from GitHub secrets
            cat > .env << EOF
            PORT=4000
            NODE_ENV=production
            DATABASE_URL="${DATABASE_URL}"
            FRONTEND_URL="${FRONTEND_URL}"
            AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
            AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
            AWS_S3_BUCKET="${AWS_S3_BUCKET}"
            AWS_REGION="${AWS_REGION}"
            UPLOAD_DIR="./uploads"
            MAX_FILE_SIZE=10485760
            EOF

            # Create uploads directories on host (for volume mount)
            mkdir -p ~/watermark-data/uploads/images ~/watermark-data/uploads/logos ~/watermark-data/uploads/processed

            # Stop and remove existing container
            docker stop watermark-api 2>/dev/null || true
            docker rm watermark-api 2>/dev/null || true

            # Build Docker image
            docker build -t watermark-api .

            # Run Docker container
            docker run -d \
              --name watermark-api \
              --restart unless-stopped \
              -p 4000:4000 \
              -v ~/watermark-data/uploads:/app/uploads \
              --env-file .env \
              watermark-api

            # Wait for container to start
            sleep 5

            # Health check
            curl -f http://localhost:4000/health || echo "Health check failed"

            # Show container status
            docker ps | grep watermark-api

      - name: Deployment complete
        run: echo "Backend deployed successfully with Docker!"
